# TED (Termux Editor) 开发计划

## 项目概述

**项目目标**: 为 Termux 用户打造的现代化、触屏友好的代码编辑器，替代 vim 的轻量级方案

**技术栈**: C + sp.h 库

**代码规模**: ~2000 行（目标）

**当前状态**: MVP 基础框架完成

## 当前实现状态分析

### 已完成模块

| 模块 | 完成度 | 状态 |
|------|--------|------|
| 项目结构 | 90% | Makefile、目录结构完整 |
| 核心数据结构 | 80% | buffer_t、editor_t、cursor_t 等定义完整 |
| 终端显示 (display.c) | 70% | ANSI 转义序列渲染、状态栏、消息栏 |
| 文本缓冲区 (buffer.c) | 60% | 基础行管理、文件读写 |
| 编辑器逻辑 (editor.c) | 50% | 模式切换、光标移动、基础操作 |
| 输入处理 (input.c) | 40% | 键位映射、模式处理 |
| 语法高亮 (syntax.c) | 30% | 语言检测、基础关键字着色 |
| 搜索功能 (search.c) | 20% | 基础搜索状态管理 |
| 命令模式 (command.c) | 20% | 命令解析框架 |
| 撤销重做 (undo.c) | 30% | 动作记录栈 |
| 主程序 (main.c) | 80% | 参数解析、主循环 |

## TUI 设计评估 (vs PRD 要求)

### PRD 要求的 UI 布局
```
┌──────────────────────────────────────────────────┐
│ TED - config.py                          [+]     │ ← 标题栏
├──────────────────────────────────────────────────┤
│  1  #!/usr/bin/env python3                       │
│  2  import os                                    │
│  3  import sys                                   │
│  4                                               │
│  5  def main():                                  │
│  6      print("Hello, Termux!")                  │
│  7                                               │
│ ...                                              │ ← 编辑区
│                                                  │
├──────────────────────────────────────────────────┤
│ [SEARCH] query: _                                │ ← 搜索栏（按需显示）
├──────────────────────────────────────────────────┤
│ Ln 6, Col 5 | Python | UTF-8 | 256 bytes | MOD  │ ← 状态栏
└──────────────────────────────────────────────────┘
```

### 当前 TUI 实现差距

| 组件 | PRD 要求 | 当前实现 | 状态 |
|------|----------|----------|------|
| 标题栏 | 显示文件名和修改状态 | ❌ 未实现 | 缺失 |
| 编辑区 | 语法高亮、行号、制表符处理 | ⚠️ 部分实现 | 基础渲染完成，语法高亮未集成 |
| 搜索栏 | 按需显示的搜索界面 | ⚠️ 框架存在 | 有状态但无交互 |
| 状态栏 | 多信息状态显示 | ✅ 基本实现 | 显示文件名、行列、语言、行数 |
| 消息栏 | 命令/消息显示 | ✅ 实现 | 支持命令模式、搜索模式、状态消息 |

### 关键视觉问题

1. **颜色方案不一致**: PRD 定义了特定颜色，当前使用不同 ANSI 代码
2. **布局偏移**: 状态栏位置计算可能不准确（屏幕行数减2）
3. **缺少标题栏**: PRD 要求的标题栏未实现
4. **搜索栏显示逻辑**: 未实现按需显示和交互

## 缺失功能清单 (按 PRD 优先级)

### 高优先级 (MVP 必需)

#### 文件操作
- [ ] 新建文件（当前有空缓冲区但无新建命令）
- [ ] 另存为 (`Ctrl+Shift+S`)
- [ ] 自动检测文件编码（UTF-8）

#### 基础编辑
- [ ] 选择文本（Shift + 方向键）
- [ ] 剪切/复制/粘贴（剪贴板集成）
- [ ] 行操作完整实现：
  - 删除整行 (`Ctrl+D`)
  - 复制行 (`Ctrl+C`，无选区时)
  - 剪切行 (`Ctrl+X`，无选区时)

#### 导航
- [ ] 跳转到文件首/尾 (`Ctrl+Home/End`)
- [ ] 单词跳转 (`Ctrl+Left/Right`)
- [ ] 滚动视图（当前有偏移但无滚动控制）

#### 搜索功能
- [ ] 搜索交互界面 (`Ctrl+F`)
- [ ] 向前/向后查找
- [ ] 大小写敏感/不敏感选项
- [ ] 高亮所有匹配项
- [ ] 替换功能 (`Ctrl+H`)
  - 替换当前
  - 全部替换
  - 确认替换模式

### 中优先级 (核心体验)

#### 语法高亮
- [ ] 完整语言支持：
  - C/C++
  - Python
  - JavaScript
  - Shell
  - Markdown
- [ ] 字符串/注释识别
- [ ] 自动检测语言（基于扩展名）

#### 显示优化
- [ ] 自动换行（可切换）
- [ ] 制表符宽度设置
- [ ] 空白字符显示（可选）
- [ ] 文件大小显示
- [ ] 修改状态显示（`[+]` 标记）

### 低优先级 (增强功能)

#### Termux 特化功能
- [ ] 触屏优化：
  - 滑动导航（左右滑动光标，上下滑动滚动）
  - 长按操作菜单（复制/粘贴/选择）
  - 双击操作（选中单词，三连击选中整行）
- [ ] 简化键位绑定完整实现
- [ ] 命令模式完整命令集

## 技术债务与架构问题

### 1. sp.h 库集成问题
- API 使用不规范（已部分修复）
- 内存管理策略不清晰
- 错误处理机制不统一

### 2. 终端兼容性问题
- Termux 环境特殊处理
- raw mode 初始化失败处理
- 屏幕尺寸获取可靠性

### 3. 代码结构问题
- 全局变量 `E` 的使用
- 模块间耦合度较高
- 错误处理分散

### 4. 构建系统
- Makefile 需要优化 Termux 兼容性
- 缺少测试框架
- 缺少安装/卸载脚本优化

## 开发计划 (分阶段)

### Phase 1: 基础修复与终端兼容 (1-2天)
1. 解决 `tcgetattr` 错误，添加 Termux 环境检测
2. 修复终端初始化，提供兼容回退模式
3. 确保程序能正常启动并显示界面
4. 测试基础光标移动和文本输入

### Phase 2: 核心编辑功能完善 (3-5天)
1. 实现选择文本和剪贴板操作
2. 完善行操作（删除、复制、剪切）
3. 实现滚动控制和导航快捷键
4. 添加文件新建/另存为功能

### Phase 3: 搜索与替换功能 (2-3天)
1. 实现搜索交互界面
2. 添加搜索选项（大小写、方向）
3. 实现替换功能
4. 添加搜索高亮显示

### Phase 4: 语法高亮优化 (2-3天)
1. 完善各语言关键字定义
2. 实现字符串/注释识别
3. 添加自动语言检测
4. 优化高亮性能

### Phase 5: Termux 特化功能 (2-3天)
1. 研究 Termux 触屏输入处理
2. 实现简化键位绑定
3. 添加命令模式完整命令集
4. 优化移动端用户体验

### Phase 6: 测试与优化 (1-2天)
1. 添加单元测试框架
2. 性能测试与优化
3. 内存泄漏检测
4. 用户体验打磨

## 测试策略

### 单元测试
1. 缓冲区操作测试
2. 语法高亮逻辑测试
3. 搜索算法测试

### 集成测试
1. 终端渲染测试
2. 文件读写测试
3. 用户交互流程测试

### 端到端测试
1. Termux 环境真实测试
2. 性能测试（大文件处理）
3. 兼容性测试（不同终端）

## 风险与缓解

### 技术风险
1. **Termux 终端兼容性**: 研究 Termux 文档，提供多套终端处理方案
2. **sp.h 学习曲线**: 参考已积累的最佳实践，建立开发规范
3. **性能问题**: 采用渐进式优化，优先确保功能正确性

### 资源风险
1. **开发时间有限**: 优先实现 MVP 功能，延迟高级特性
2. **测试环境限制**: 利用现有 Termux 环境，模拟测试条件

### 质量风险
1. **内存泄漏**: 使用 valgrind 或 AddressSanitizer 定期检查
2. **崩溃风险**: 添加核心操作的边界检查
3. **数据丢失**: 实现自动保存和恢复机制

## 成功指标

### 技术指标
- ✅ 支持 UTF-8 编码
- ✅ 打开 1MB 文件 < 1 秒
- ✅ 语法高亮不影响编辑流畅度
- ✅ 内存占用 < 10MB

### 用户体验指标
- ✅ 新用户 5 分钟内学会基础操作
- ✅ 比 vim 更快完成简单编辑任务
- ✅ 稳定性：无崩溃、无数据丢失
- ✅ Termux 环境友好度评分 > 4/5

---

*最后更新: 2026-02-14*
*基于 PRD 版本: 2026-02-13*
*当前代码版本: 0.1.0*